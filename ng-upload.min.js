angular.module("ngUpload",[]).directive("uploadSubmit",["$parse",function(){function t(n,e){n=angular.element(n);var a=n.parent();return e=e.toLowerCase(),a&&a[0].tagName.toLowerCase()===e?a:a?t(a,e):null}return{restrict:"AC",link:function(n,e){e.bind("click",function(n){if(n&&(n.preventDefault(),n.stopPropagation()),!e.attr("disabled")){var a=t(e,"form");a.triggerHandler("submit"),a[0].submit()}})}}}]).directive("ngUpload",["$log","$parse","$document",function(t,n,e){function a(t){var n,a=e.find("head");return angular.forEach(a.find("meta"),function(e){e.getAttribute("name")===t&&(n=e)}),angular.element(n)}var r=1;return{restrict:"AC",link:function(t,e,o){function i(n){t.$isUploading=n}function l(){f.unbind("load"),t.safeApply(function(){i(!1)});var n;try{var e=(f[0].contentDocument||f[0].contentWindow.document).body;n=e.innerText||e.textContent}catch(a){if(n={result:{},status:"FAIL",errors:[{code:4007,message:"文件过大"}]},s)return t.safeApply(function(){s(t,{content:{code:1,message:"上传文件超时"}})}),void 0}try{n=angular.fromJson(n)}catch(a){if(s)return t.safeApply(function(){s(t,{content:{code:1,message:"js验证错误"}})}),void 0}t.safeApply(function(){d(t,{content:n})})}t.safeApply=function(t){var n=this.$root.$$phase;"$apply"==n||"$digest"==n?t&&"function"==typeof t&&t():this.$apply(t)},r++;var u={},d=o.ngUpload?n(o.ngUpload):angular.noop,p=o.ngUploadLoading?n(o.ngUploadLoading):null,s=o.ngError?n(o.ngError):null;o.hasOwnProperty("uploadOptionsConvertHidden")&&(u.convertHidden="false"!=o.uploadOptionsConvertHidden),o.hasOwnProperty("uploadOptionsEnableRailsCsrf")&&(u.enableRailsCsrf="false"!=o.uploadOptionsEnableRailsCsrf),o.hasOwnProperty("uploadOptionsBeforeSubmit")&&(u.beforeSubmit=n(o.uploadOptionsBeforeSubmit)),e.attr({target:"upload-iframe-"+r,method:"post",enctype:"multipart/form-data",encoding:"multipart/form-data"});var f=angular.element('<iframe name="upload-iframe-'+r+'" '+'border="0" width="0" height="0" '+'style="width:0px;height:0px;border:none;display:none">');if(u.enableRailsCsrf){var c=angular.element("<input />");c.attr("class","upload-csrf-token"),c.attr("type","hidden"),c.attr("name",a("csrf-param").attr("content")),c.val(a("csrf-token").attr("content")),e.append(c)}e.after(f),i(!1),e.bind("submit",function(){var n=t[o.name];return n&&n.$invalid?!1:u.beforeSubmit&&0==u.beforeSubmit(t,{})?!1:(f.bind("load",l),u.convertHidden&&angular.forEach(e.find("input"),function(n){var e=angular.element(n);e.attr("ng-model")&&e.attr("type")&&"hidden"==e.attr("type")&&e.attr("value",t.$eval(e.attr("ng-model")))}),t.safeApply(function(){p&&p(t),i(!0)}),void 0)})}}}]);